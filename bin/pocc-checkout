#!/usr/bin/perl -w
## pocc-checkout for pocc in /Users/pouchet
##
## Made by Louis-Noel Pouchet
## Contact: <louis-noel.pouchet@inria.fr>
##
## Started on  Tue Apr 14 17:43:47 2009 Louis-Noel Pouchet
## Last update Thu Apr 23 04:40:42 2009 Louis-Noel Pouchet
##

use Switch;
use Term::ANSIColor;

## Some global variables.
$BASEDIR = "/Users/pouchet/inria/projects/pocc";
$REPOSITORIES = "$BASEDIR/config/repositories.cfg";


## Args: soft name, destination directory, url
sub checkout_git
{
    my ($soft, $dir, $url) = @_;
    print "** Git cloning $soft (from $url) in $dir...\n";
    system("git clone $url $BASEDIR/$dir/$soft/trunk");
}


## Args: soft name, destination directory, url
sub checkout_wget
{
    my ($soft, $dir, $url) = @_;
    print "** Wgetting $soft (from $url) in $dir...\n";
    system("mkdir -p $BASEDIR/$dir/$soft && cd $BASEDIR/$dir/$soft && wget $url");
    my @tmp = split(/\//, $url);
    my $filename = $tmp[$#tmp];
    if ($filename =~ /.tar.gz$|.tgz$/) {
	system("cd $BASEDIR/$dir/$soft && tar xzf $filename");
    }
    else {
	if ($filename =~ /.zip$/) {
	    system("cd $BASEDIR/$dir/$soft && unzip $filename");
	}
    }
}


## Args: soft name, destination directory, url, mode
sub checkout_svn
{
    my ($soft, $dir, $url, $mode) = @_;
    my $svnuser = "";
    $svnuser = "--username pocc --password pocc" if ($mode =~ /base/);
    print "** SVN checkouting $soft (from $url) in $dir...\n";
    system("svn co $url/trunk $BASEDIR/$dir/$soft/trunk") if ($mode =~ /trunk/);
    system("svn co $url $BASEDIR/$dir/$soft") if ($mode =~ /devel/);
    if ($mode =~ /base/) {
	system("svn co $svnuser $url/trunk $BASEDIR/$dir/$soft/trunk");
    }
}


## Args: checkout method
sub checkout
{
    my ($repos) = @_;
    print (colored ("* Full checkout of PoCC. This may take a while...", "green green"), "\n");
    print "* Checkout mode: $repos\n";
    open FILE, "$REPOSITORIES" or die $!;
    while (<FILE>) {
	if ($_ !~ /^#/) {
	    my ($soft, $dir, $method, $url) = split(/[\t\s]+/, $_);
	    switch ($method) {
		case "svn"  { checkout_svn($soft, $dir, $url, $repos); }
		case "git"  { checkout_git($soft, $dir, $url); }
		case "wget" { checkout_wget($soft, $dir, $url); }
	    }
	}
    }
    print (colored ("* Checkout done", "green green"), "\n");
}

